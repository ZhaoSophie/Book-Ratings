<!DOCTYPE html>
<html>

<head>
  <title>What factors impact the rating of a book?</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    div {
      display: flex;
      justify-content: center;
    }

    .gridlines line {
      stroke: #bbb;
    }

    .gridlines .domain {
      stroke: #bbb;
    }

    body,
    html {
      /* display: flex; */
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 30px;
    }

    button {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid gray;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    button:hover {
      border: 1px solid black;
      /* Darker blue when clicked */
      transform: scale(0.98);
      /* Thicker border on hover */
    }

    .tooltip {
      visibility: hidden;
      width: 120px;
      background-color: black;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 0;

      /* Position the tooltip */
      position: absolute;
      z-index: 1;
    }

    .tooltip:hover {
      visibility: visible;
    }

    .page-title {
      font-size: 2.5rem;
      font-weight: bold;
      text-align: center;
      margin: 20px;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
      border: 2px solid #ccc;
      border-radius: 10px;
      box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body>
  <h1 class="page-title">What factors impact the rating of a book?</h1>
  <div>
    <svg height="600" width="600" style="border: 1px solid black;">
      <g stroke="#6e2c00" fill="#6e2c00">

        <!-- Shelf pillars -->
        <rect x="30" y="80" width="15" height="500" />
        <rect x="555" y="80" width="15" height="500" />

        <!-- Horizontal shelves -->
        <rect x="30" y="80" width="540" height="15" />
        <rect x="30" y="180" width="540" height="15" />
        <rect x="30" y="280" width="540" height="15" />
        <rect x="30" y="380" width="540" height="15" />
        <rect x="30" y="480" width="540" height="15" />
        <rect x="30" y="580" width="540" height="15" />

        <!-- Books on shelves -->

        <!-- 1st Shelf -->
        <!-- <g fill="#d35400">
          <rect x="50" y="140" width="40" height="40" />
          <rect x="100" y="140" width="40" height="40" />
          <rect x="150" y="140" width="40" height="40" />
          <rect x="200" y="140" width="40" height="40" />
          <rect x="250" y="140" width="40" height="40" />
          <rect x="300" y="140" width="40" height="40" />
          <rect x="350" y="140" width="40" height="40" />
          <rect x="400" y="140" width="40" height="40" />
          <rect x="450" y="140" width="40" height="40" />
          <rect x="500" y="140" width="40" height="40" />
        </g> -->

        <!-- 2rd Shelf -->
        <!-- <g fill="#7e5109">
          <rect x="50" y="240" width="40" height="40" />
          <rect x="100" y="240" width="40" height="40" />
          <rect x="150" y="240" width="40" height="40" />
          <rect x="200" y="240" width="40" height="40" />
          <rect x="250" y="240" width="40" height="40" />
          <rect x="300" y="240" width="40" height="40" />
          <rect x="350" y="240" width="40" height="40" />
          <rect x="400" y="240" width="40" height="40" />
          <rect x="450" y="240" width="40" height="40" />
          <rect x="500" y="240" width="40" height="40" />
        </g> -->

        <!-- 3rd Shelf -->
        <!-- <g fill="#a04000">
          <rect x="50" y="340" width="40" height="40" />
          <rect x="100" y="340" width="40" height="40" />
          <rect x="150" y="340" width="40" height="40" />
          <rect x="200" y="340" width="40" height="40" />
          <rect x="250" y="340" width="40" height="40" />
          <rect x="300" y="340" width="40" height="40" />
          <rect x="350" y="340" width="40" height="40" />
          <rect x="400" y="340" width="40" height="40" />
          <rect x="450" y="340" width="40" height="40" />
          <rect x="500" y="340" width="40" height="40" />
        </g> -->

        <!-- 4th Shelf -->
        <!-- <g fill="#ae2e00">
          <rect x="50" y="440" width="40" height="40" />
          <rect x="100" y="440" width="40" height="40" />
          <rect x="150" y="440" width="40" height="40" />
          <rect x="200" y="440" width="40" height="40" />
          <rect x="250" y="440" width="40" height="40" />
          <rect x="300" y="440" width="40" height="40" />
          <rect x="350" y="440" width="40" height="40" />
          <rect x="400" y="440" width="40" height="40" />
          <rect x="450" y="440" width="40" height="40" />
          <rect x="500" y="440" width="40" height="40" />
        </g> -->

        <!-- 5th Shelf -->
        <!-- <g fill="#6e2c00">
          <rect x="50" y="540" width="40" height="40" />
          <rect x="100" y="540" width="40" height="40" />
          <rect x="150" y="540" width="40" height="40" />
          <rect x="200" y="540" width="40" height="40" />
          <rect x="250" y="540" width="40" height="40" />
          <rect x="300" y="540" width="40" height="40" />
          <rect x="350" y="540" width="40" height="40" />
          <rect x="400" y="540" width="40" height="40" />
          <rect x="450" y="540" width="40" height="40" />
          <rect x="500" y="540" width="40" height="40" />
        </g> -->

      </g>
    </svg>
  </div>




  <h2>The scatterplots for the data: </h2>
  <div>
    <button id="Romance">Romance</button>
    <button id="Mystery">Mystery</button>
    <button id="Historical_Fiction">Historical Fiction</button>
    <button id="Science_Fiction">Science Fiction</button>
    <button id="Nonfiction">Nonfiction</button>
    <button id="Clear">Clear</button>
  </div>
  <div>
    <svg id="num_pages" width="600" height="600"></svg>
  </div>
  <div>
    <svg id="publication_date" width="600" height="600"></svg>
  </div>
  <div>
    <svg id="price" width="600" height="600"></svg>
  </div>

  <script>

    const svg = d3.select("svg");
    const width = svg.attr("width");
    const height = svg.attr("height");

    const bookWidth = 23;
    const spaceBetweenBooks = 10;
    const bookHeight = 70;
    const booksPerShelf = 15
    const shelfHeight = 100;

    const requestData = async function () {
      let data = await d3.csv('data/books.csv');
      console.log("data", data);

      let num_genres = new Map() // map of genres to # of books
      let genres_books = new Map()
      let genres = ['Romance', 'Mystery', 'Historical Fiction', 'Science Fiction', 'Nonfiction']

      // The books where one of the genres is among the top 5 genres 
      let top_genre_books = []

      genres.forEach((g) => {
        num_genres.set(g, 0);
      })

      data.forEach((d, i) => {
        let genres_list = d['genres'].slice(2, -2).split("', '") // get list of genres for book
        let len = genres_list.length;

        // find first genre that's in top 5 genres
        var i = 0;
        let genre = genres_list[i];
        while (!num_genres.has(genre)) {
          i += 1;
          if (i == len) {
            genre = "";
            break;
          } else {
            genre = genres_list[i];
          }
        }

        // at this point, 'genre' is the genre (within top 5) of the book
        d['top_genre'] = genre; // adding the top genre as a new field

        // Reformatting some data
        convert_to_num = ['current_readers', 'num_pages', 'num_ratings', 'num_reviews',
          'price', 'rating_score', 'want_to_read'];
        convert_to_num.forEach((category, i) => {
          d[category] = Number(d[category]);
        });

        const parseDate = d3.timeParse("%d-%b-%y");
        d['publication_date'] = parseDate(d['publication_date']);

        // fill map with counts of books
        if (genre != "") {
          num_genres.set(genre, num_genres.get(genre) + 1)
        }

        // add valid points to the dataset for scatterplots
        if (genre != "" && d['num_pages'] > 0) {
          top_genre_books.push(d);
        }
      });

      console.log("num_genres", num_genres);
      console.log("top_genre_books", top_genre_books);

      // ----- Books on Shelf -----

      // Genre color scale
      const genreColors = d3.schemeTableau10;
      const genreScale = d3.scaleOrdinal(genres, genreColors);
      const minRating = d3.min( data, d => d.rating_score );
      const maxRating = d3.max( data, d => d.rating_score );
      const bookLightness = d3.scaleLinear().domain([minRating, maxRating])
                                            .range([0.3, 1])
      // subset of books to be added to the bookshelf
      const booksForShelf = []

      /*
      for each genre, take the first 15 books that have this genre as its top genre
      Note: dataset is sorted by highest number of reviews first
      */
      genres.forEach(genre => {
        let booksInGenre = top_genre_books.filter(d => (d.top_genre === genre))
                                          .slice(0, booksPerShelf)
        booksInGenre.sort(function(a, b){
          return a["publication_date"] - b["publication_date"]
        });
        booksForShelf.push(booksInGenre);
      })
      console.log("booksForShelf", booksForShelf);

      // get average rating per shelf
      const genreRatingsMap = new Map();
      booksForShelf.forEach(genre => {
        let totalRating = 0
        for (let i = 0; i < genre.length; i++){
          totalRating += genre[i].rating_score
        }
        genreRatingsMap.set(genre[0].top_genre, totalRating/genre.length)
      })

      // turn booksForShelf into a map of genres to the books in the genre
      const shelfMap = new Map()
      booksForShelf.forEach(array => {
        shelfMap.set(array[0].top_genre, array)
      })
      console.log("shelfMap", shelfMap)

      // sort genre list with ratings by highest ratings
      const genreRatingsArr = [...genreRatingsMap.entries()].sort((a, b) => b[1] - a[1])
      console.log("genreRatingsArr", genreRatingsArr)

      // add books to the shelf
      let index = 0
      genreRatingsArr.forEach(genreGroup => {
        for (let j = 0; j < booksPerShelf; j++){
          let genre = genreGroup[0];
          let book = shelfMap.get(genre)[j];
          let xPos = 55+j*(bookWidth+spaceBetweenBooks);
          let yPos = 115+index*(shelfHeight);
          let bookColor = d3.hsl(genreScale(book.top_genre));
          bookColor.l = bookLightness(book.rating_score);

          svg.append("rect")
              .attr("x", xPos)
              .attr("y", yPos)
              .attr("width", bookWidth)
              .attr("height", bookHeight)
              .attr("fill", bookColor);
        }
        index ++;
      })

      // ----- SCATTERPLOTS -----
      num_pages_chartArea = createScatterplot(top_genre_books, 'num_pages', d3.scaleLinear(), 'rating_score', genreScale);
      publication_date_chartArea = createScatterplot(top_genre_books, 'publication_date', d3.scaleTime(), 'rating_score', genreScale);
      price_chartArea = createScatterplot(top_genre_books, 'price', d3.scaleLinear(), 'rating_score', genreScale);

      const chartAreas = [num_pages_chartArea, publication_date_chartArea, price_chartArea];

      // // legend buttons
      genres.forEach(genre => {
        const g = genre.replace(' ', '_');
        d3.select('#' + g)
          .style("background-color", genreScale(genre))
          .on("click", () => {
            // console.log(genre);
            chartAreas.forEach(c => {
              c.selectAll("circle." + g)
                .transition().duration(400)
                .style("opacity", 0.8);

              c.selectAll("circle:not(." + g + ")")
                .transition().duration(400)
                .style("opacity", 0.1);
            });
          });
      })

      d3.select('#Clear')
        .on("click", () => {
          // console.log("Clear");
          chartAreas.forEach(c => {
            c.selectAll("circle")
              .transition().duration(400)
              .style("opacity", 0.4);
          });
        });
    }

    function createScatterplot(top_genre_books, x_var, x_scale_func, y_var, genreScale) {
      // General dimensions of every scatterplot are the same
      const svg = d3.select('#' + x_var);
      const width = svg.attr('width');
      const height = svg.attr('height');
      const margins = { top: 40, right: 20, bottom: 60, left: 55 };
      const chartWidth = width - margins.left - margins.right;
      const chartHeight = height - margins.top - margins.bottom;

      let chartArea = svg.append('g')
        .attr('transform', `translate(${margins.left},${margins.top})`);

      svg.append("text")
        .attr("class", "title")
        .attr("text-anchor", "middle")
        .attr("x", chartWidth / 2 + margins.left)
        .attr("y", 20)
        .text(formatLabel(y_var, "title") + " vs. " + formatLabel(x_var, "title"));

      // create scales
      const xExtent = d3.extent(top_genre_books, d => d[x_var]);
      const xScale = x_scale_func.domain(xExtent).range([0, chartWidth]);
      const yExtent = d3.extent(top_genre_books, d => d[y_var]);
      const yScale = d3.scaleLinear().domain(yExtent).range([chartHeight, 0]);

      let leftGridlines = d3.axisLeft(yScale)
        .tickSize(-chartWidth - 10)
        .tickFormat('');
      svg.append('g')
        .attr('class', 'y gridlines')
        .attr('transform', `translate(${margins.left},${margins.top})`)
        .call(leftGridlines);

      let bottomGridlines = d3.axisBottom(xScale)
        .tickSize(-chartHeight - 10)
        .tickFormat('');
      svg.append('g')
        .attr('class', 'x gridlines')
        .attr('transform', `translate(${margins.left},${chartHeight + margins.top})`)
        .call(bottomGridlines);

      let leftAxis = d3.axisLeft(yScale);
      svg.append('g')
        .attr('class', 'y axis')
        .attr('transform', `translate(${margins.left},${margins.top})`)
        .call(leftAxis);

      let bottomAxis = d3.axisBottom(xScale);
      svg.append('g')
        .attr('class', 'x axis')
        .attr('transform', `translate(${margins.left},${chartHeight + margins.top})`)
        .call(bottomAxis);

      // adding labels
      svg.append("text")
        .attr("class", "y label")
        .attr("text-anchor", "middle")
        .attr("x", -chartHeight / 2 - margins.top)
        .attr("y", 20)
        .attr("transform", "rotate(-90)")
        .text(formatLabel(y_var, "axis"));

      svg.append("text")
        .attr("class", "x label")
        .attr("text-anchor", "middle")
        .attr("x", chartWidth / 2 + margins.left)
        .attr("y", height - 20)
        .text(formatLabel(x_var, "axis"));

      let circles = chartArea.selectAll("circle").data(top_genre_books)
        .join("circle")
        .attr("id", d => d['title'].replaceAll(' ', '_'))
        .attr("class", d => d['top_genre'].replace(' ', '_'))
        .attr("cx", d => xScale(d[x_var]))
        .attr("cy", d => yScale(d[y_var]))
        .attr("r", 5)
        .style("fill", d => genreScale(d['top_genre']))
        .style("opacity", 0.4);

      chartArea.raise();

      // show title/author of book when hovering over circle
      const tooltipWidth = 100;
      const tooltipHeight = 45;

      // var label = svg.append("text").attr("id", "label");

      var box = svg.append("span").attr("class", "tooltip");

      // let tooltip = svg.append("g")
      //   .attr("class", "tooltip")
      //   .attr("visibility", "hidden");

      // tooltip.append("rect")
      //   .attr("fill", "black")
      //   .attr("opacity", 0.9)
      //   .attr("x", -tooltipWidth / 2.0)
      //   .attr("y", 0)
      //   .attr("width", tooltipWidth)
      //   .attr("height", tooltipHeight)
      //   .attr("border-radius", 2)

      // let title_txt = tooltip.append("text")
      //   .attr("fill", "white")
      //   .attr("text-anchor", "middle")
      //   .attr("alignment-baseline", "hanging")
      //   .attr("x", 0)
      //   .attr("y", 5);
      // let author_txt = tooltip.append("text")
      //   .attr("fill", "white")
      //   .attr("text-anchor", "middle")
      //   .attr("alignment-baseline", "hanging")
      //   .attr("x", 0)
      //   .attr("y", 25);

      circles.on("mouseover", function (event) {
        let circle = d3.select(this);
        let book = circle.datum();
        let title = book['title'];
        let authors = book['authors'];
        let isbn = book['isbn']; // used as id for each circle

        circle.raise()
          .transition().duration(200)
          .attr("r", 8)
          .attr("stroke-width", 1)
          .attr("stroke", d => darken(genreScale(d['top_genre']), 30))
          .style("opacity", 1)
          .style("fill", d => darken(genreScale(d['top_genre']), 10));

        // for debugging purposes
        // console.log(circle.node());
        // console.log("cx:", circle.attr('cx'));
        // console.log("cy:", circle.attr('cy'));

        // label.text(title + " by " + authors)
        //   .attr("x", circle.attr('cx'))
        //   .attr("y", circle.attr('cy'));

        box.attr("visibility", "visible")
          .attr("text", title + " by " + authors)
          .attr("transform", `translate(${circle.attr('cx')},${circle.attr('cy')})`);

        // tooltip.style("visibility", "visible");
        // title_txt.text(title);
        // author_txt.text(authors);
        // tooltip.attr("transform", `translate(${circle.attr('cx')},${circle.attr('cy')})`);
      });

      circles.on("mouseout", function () {
        let circle = d3.select(this);
        circle.transition().duration(200)
          .attr("r", 5)
          .attr("stroke-width", 1)
          .attr("stroke", "none")
          .style("opacity", 0.4)
          .style("fill", d => genreScale(d['top_genre']));

        // label.text("");
      });

      return chartArea;
    }

    // helper function: darken a color
    // inspired by lighten(color) from Prof. Rzeszotarski
    function darken(color, amount) {
      let hclColor = d3.hcl(color);
      let luma = Math.min(130, hclColor.l - amount);
      return d3.rgb(d3.hcl(hclColor.h, hclColor.c, luma));
    }

    // helper function: returns label without _ and capitalized
    function formatLabel(label, type) {
      if (label == "num_pages") {
        label = "number_of_pages"
      }
      formatted = label.toLowerCase()
        .split('_')
        .map(s => s.charAt(0).toUpperCase() + s.substring(1))
        .join(' ');

      return formatted
    }

    requestData();
  </script>
</body>

</html>