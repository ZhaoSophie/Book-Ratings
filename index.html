<!DOCTYPE html>
<html>

<head>
  <title>What factors impact the rating of a book?</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    .gridlines line {
      stroke: #bbb;
    }

    .gridlines .domain {
      stroke: #bbb;
    }

    body,
    html {
      /* display: flex; */
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 30px;
    }

    button {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid gray;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    button:hover {
      border: 1px solid black;
      /* Darker blue when clicked */
      transform: scale(0.98);
      /* Thicker border on hover */
    }

    .tooltip {
      visibility: hidden;
      width: 120px;
      background-color: black;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 0;

      /* Position the tooltip */
      position: absolute;
      z-index: 1;
    }

    .tooltip:hover {
      visibility: visible;
    }
  </style>
</head>

<body>
  <div>
    <svg height="460" width="300" style="border: 1px solid black;">
      <g stroke="#6e2c00" fill="#6e2c00">

        <!-- Shelf pillars -->
        <rect x="20" y="60" width="10" height="380" />
        <rect x="270" y="60" width="10" height="380" />

        <!-- Horizontal shelves -->
        <rect x="20" y="60" width="260" height="10" />
        <rect x="20" y="150" width="260" height="10" />
        <rect x="20" y="240" width="260" height="10" />
        <rect x="20" y="330" width="260" height="10" />
        <rect x="20" y="420" width="260" height="10" />

      </g>
    </svg>
  </div>

  <p>The scatterplots for the data: </p>
  <div>
    <button id="Romance">Romance</button>
    <button id="Mystery">Mystery</button>
    <button id="Historical_Fiction">Historical Fiction</button>
    <button id="Science_Fiction">Science Fiction</button>
    <button id="Nonfiction">Nonfiction</button>
    <button id="Clear">Clear</button>
  </div>
  <div>
    <svg id="num_pages" width="600" height="600"></svg>
  </div>
  <div>
    <svg id="publication_date" width="600" height="600"></svg>
  </div>
  <div>
    <svg id="price" width="600" height="600"></svg>
  </div>

  <script>
    const requestData = async function () {
      let data = await d3.csv('../data/books.csv');
      console.log(data);

      let num_genres = new Map() // map of genres to # of books
      let genres_books = new Map()
      let genres = ['Romance', 'Mystery', 'Historical Fiction', 'Science Fiction', 'Nonfiction']

      // The books where one of the genres is among the top 5 genres 
      let top_genre_books = []

      genres.forEach((g) => {
        num_genres.set(g, 0);
      })

      data.forEach((d, i) => {
        let genres_list = d['genres'].slice(2, -2).split("', '") // get list of genres for book
        let len = genres_list.length;

        // find first genre that's in top 5 genres
        var i = 0;
        let genre = genres_list[i];
        while (!num_genres.has(genre)) {
          i += 1;
          if (i == len) {
            genre = "";
            break;
          } else {
            genre = genres_list[i];
          }
        }

        // at this point, 'genre' is the genre (within top 5) of the book
        d['top_genre'] = genre; // adding the top genre as a new field

        // Reformatting some data
        convert_to_num = ['current_readers', 'num_pages', 'num_ratings', 'num_reviews',
          'price', 'rating_score', 'want_to_read'];
        convert_to_num.forEach((category, i) => {
          d[category] = Number(d[category]);
        });

        const parseDate = d3.timeParse("%B %e, %Y");
        d['publication_date'] = parseDate(d['publication_date']);

        // fill map with counts of books
        if (genre != "") {
          num_genres.set(genre, num_genres.get(genre) + 1)
        }

        // add valid points to the dataset for scatterplots
        if (genre != "" && d['num_pages'] > 0) {
          top_genre_books.push(d);
        }
      });

      console.log(num_genres);
      console.log(top_genre_books);

      // ----- SCATTERPLOTS -----
      const genreScale = d3.scaleOrdinal(d3.schemeTableau10);
      num_pages_chartArea = createScatterplot(top_genre_books, 'num_pages', d3.scaleLinear(), 'rating_score', genreScale);
      publication_date_chartArea = createScatterplot(top_genre_books, 'publication_date', d3.scaleTime(), 'rating_score', genreScale);
      price_chartArea = createScatterplot(top_genre_books, 'price', d3.scaleLinear(), 'rating_score', genreScale);

      const chartAreas = [num_pages_chartArea, publication_date_chartArea, price_chartArea];

      // // legend buttons
      genres.forEach(genre => {
        const g = genre.replace(' ', '_');
        d3.select('#' + g)
          .style("background-color", genreScale(genre))
          .on("click", () => {
            // console.log(genre);
            chartAreas.forEach(c => {
              c.selectAll("circle." + g)
                .transition().duration(400)
                .style("opacity", 0.8);

              c.selectAll("circle:not(." + g + ")")
                .transition().duration(400)
                .style("opacity", 0.1);
            });
          });
      })

      d3.select('#Clear')
        .on("click", () => {
          // console.log("Clear");
          chartAreas.forEach(c => {
            c.selectAll("circle")
              .transition().duration(400)
              .style("opacity", 0.4);
          });
        });
    }

    function createScatterplot(top_genre_books, x_var, x_scale_func, y_var, genreScale) {
      // General dimensions of every scatterplot are the same
      const svg = d3.select('#' + x_var);
      const width = svg.attr('width');
      const height = svg.attr('height');
      const margins = { top: 40, right: 20, bottom: 60, left: 55 };
      const chartWidth = width - margins.left - margins.right;
      const chartHeight = height - margins.top - margins.bottom;

      let chartArea = svg.append('g')
        .attr('transform', `translate(${margins.left},${margins.top})`);

      svg.append("text")
        .attr("class", "title")
        .attr("text-anchor", "middle")
        .attr("x", chartWidth / 2 + margins.left)
        .attr("y", 20)
        .text(formatLabel(y_var, "title") + " vs. " + formatLabel(x_var, "title"));

      // create scales
      const xExtent = d3.extent(top_genre_books, d => d[x_var]);
      const xScale = x_scale_func.domain(xExtent).range([0, chartWidth]);
      const yExtent = d3.extent(top_genre_books, d => d[y_var]);
      const yScale = d3.scaleLinear().domain(yExtent).range([chartHeight, 0]);

      let leftGridlines = d3.axisLeft(yScale)
        .tickSize(-chartWidth - 10)
        .tickFormat('');
      svg.append('g')
        .attr('class', 'y gridlines')
        .attr('transform', `translate(${margins.left},${margins.top})`)
        .call(leftGridlines);

      let bottomGridlines = d3.axisBottom(xScale)
        .tickSize(-chartHeight - 10)
        .tickFormat('');
      svg.append('g')
        .attr('class', 'x gridlines')
        .attr('transform', `translate(${margins.left},${chartHeight + margins.top})`)
        .call(bottomGridlines);

      let leftAxis = d3.axisLeft(yScale);
      svg.append('g')
        .attr('class', 'y axis')
        .attr('transform', `translate(${margins.left},${margins.top})`)
        .call(leftAxis);

      let bottomAxis = d3.axisBottom(xScale);
      svg.append('g')
        .attr('class', 'x axis')
        .attr('transform', `translate(${margins.left},${chartHeight + margins.top})`)
        .call(bottomAxis);

      // adding labels
      svg.append("text")
        .attr("class", "y label")
        .attr("text-anchor", "middle")
        .attr("x", -chartHeight / 2 - margins.top)
        .attr("y", 20)
        .attr("transform", "rotate(-90)")
        .text(formatLabel(y_var, "axis"));

      svg.append("text")
        .attr("class", "x label")
        .attr("text-anchor", "middle")
        .attr("x", chartWidth / 2 + margins.left)
        .attr("y", height - 20)
        .text(formatLabel(x_var, "axis"));

      let circles = chartArea.selectAll("circle").data(top_genre_books)
        .join("circle")
        .attr("id", d => d['title'].replaceAll(' ', '_'))
        .attr("class", d => d['top_genre'].replace(' ', '_'))
        .attr("cx", d => xScale(d[x_var]))
        .attr("cy", d => yScale(d[y_var]))
        .attr("r", 5)
        .style("fill", d => genreScale(d['top_genre']))
        .style("opacity", 0.4);

      chartArea.raise();

      // show title/author of book when hovering over circle
      const tooltipWidth = 100;
      const tooltipHeight = 45;

      // var label = svg.append("text").attr("id", "label");

      var box = svg.append("span").attr("class", "tooltip");

      // let tooltip = svg.append("g")
      //   .attr("class", "tooltip")
      //   .attr("visibility", "hidden");

      // tooltip.append("rect")
      //   .attr("fill", "black")
      //   .attr("opacity", 0.9)
      //   .attr("x", -tooltipWidth / 2.0)
      //   .attr("y", 0)
      //   .attr("width", tooltipWidth)
      //   .attr("height", tooltipHeight)
      //   .attr("border-radius", 2)

      // let title_txt = tooltip.append("text")
      //   .attr("fill", "white")
      //   .attr("text-anchor", "middle")
      //   .attr("alignment-baseline", "hanging")
      //   .attr("x", 0)
      //   .attr("y", 5);
      // let author_txt = tooltip.append("text")
      //   .attr("fill", "white")
      //   .attr("text-anchor", "middle")
      //   .attr("alignment-baseline", "hanging")
      //   .attr("x", 0)
      //   .attr("y", 25);

      circles.on("mouseover", function (event) {
        let circle = d3.select(this);
        let book = circle.datum();
        let title = book['title'];
        let authors = book['authors'];
        let isbn = book['isbn']; // used as id for each circle

        circle.raise()
          .transition().duration(200)
          .attr("r", 8)
          .attr("stroke-width", 1)
          .attr("stroke", d => darken(genreScale(d['top_genre']), 30))
          .style("opacity", 1)
          .style("fill", d => darken(genreScale(d['top_genre']), 10));

        // for debugging purposes
        console.log(circle.node());
        console.log("cx:", circle.attr('cx'));
        console.log("cy:", circle.attr('cy'));

        // label.text(title + " by " + authors)
        //   .attr("x", circle.attr('cx'))
        //   .attr("y", circle.attr('cy'));

        box.attr("visibility", "visible")
          .attr("text", title + " by " + authors)
          .attr("transform", `translate(${circle.attr('cx')},${circle.attr('cy')})`);

        // tooltip.style("visibility", "visible");
        // title_txt.text(title);
        // author_txt.text(authors);
        // tooltip.attr("transform", `translate(${circle.attr('cx')},${circle.attr('cy')})`);
      });

      circles.on("mouseout", function () {
        let circle = d3.select(this);
        circle.transition().duration(200)
          .attr("r", 5)
          .attr("stroke-width", 1)
          .attr("stroke", "none")
          .style("opacity", 0.4)
          .style("fill", d => genreScale(d['top_genre']));

        // label.text("");
      });

      return chartArea;
    }

    // helper function: darken a color
    // inspired by lighten(color) from Prof. Rzeszotarski
    function darken(color, amount) {
      let hclColor = d3.hcl(color);
      let luma = Math.min(130, hclColor.l - amount);
      return d3.rgb(d3.hcl(hclColor.h, hclColor.c, luma));
    }

    // helper function: returns label without _ and capitalized
    function formatLabel(label, type) {
      if (label == "num_pages") {
        label = "number_of_pages"
      }
      formatted = label.toLowerCase()
        .split('_')
        .map(s => s.charAt(0).toUpperCase() + s.substring(1))
        .join(' ');

      return formatted
    }

    requestData();
  </script>
</body>

</html>